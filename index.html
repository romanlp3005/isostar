<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ISOSTAR 3D - PLANOGRAMME RESPONSIF MULTI-FORMATS v8.0</title>
    <style>
        :root {
            --isostar-yellow: #ffde00;
            --intersport-blue: #004179;
            --intersport-red: #ce0f2d;
            --bg-color: #f4f7f9;
            --panel-bg: rgba(255, 255, 255, 0.98);
            --transition-smooth: all 0.5s cubic-bezier(0.19, 1, 0.22, 1);
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body { 
            margin: 0; 
            overflow: hidden; 
            font-family: 'Segoe UI', system-ui, -apple-system, sans-serif; 
            background-color: var(--bg-color);
            height: 100vh;
        }

        /* ========================================================================
           RESPONSIVE UI : PANNEAU GAUCHE (CONTROLES ET CATALOGUE)
           ======================================================================== */
        #ui-left {
            position: absolute; 
            top: 15px; left: 15px; bottom: 15px;
            background: var(--panel-bg);
            padding: 20px; 
            border-radius: 16px;
            border-left: 6px solid var(--isostar-yellow); 
            width: 320px;
            box-shadow: 0 15px 35px rgba(0,0,0,0.1);
            display: flex; 
            flex-direction: column; 
            z-index: 1000;
            transition: var(--transition-smooth);
            backdrop-filter: blur(10px);
        }

        /* Mobile adaptation pour le panneau gauche */
        @media (max-width: 768px) {
            #ui-left {
                width: 260px;
                left: 10px; top: 10px; bottom: 10px;
                padding: 15px;
            }
            .brand-title { font-size: 20px !important; }
        }

        @media (max-width: 480px) {
            #ui-left {
                width: 100%;
                left: 0; top: auto; bottom: -70%; /* Escamotable sur mobile */
                height: 75%;
                border-radius: 20px 20px 0 0;
                border-left: none;
                border-top: 5px solid var(--isostar-yellow);
            }
            #ui-left.mobile-active { bottom: 0; }
        }

        .brand-title { 
            margin: 0; 
            font-size: 24px; 
            font-weight: 900; 
            color: #000; 
            text-transform: uppercase;
            letter-spacing: -0.5px;
        }

        .project-tag { 
            font-size: 10px; 
            color: #888; 
            font-weight: 800; 
            text-transform: uppercase; 
            letter-spacing: 1.5px;
            margin-bottom: 15px;
            display: block;
        }

        label {
            font-size: 11px;
            font-weight: 900;
            color: var(--intersport-blue);
            text-transform: uppercase;
            margin-bottom: 6px;
            display: block;
        }

        select { 
            width: 100%; 
            padding: 12px; 
            margin-bottom: 20px; 
            border: 2px solid #edf2f7; 
            border-radius: 10px; 
            background: #fff; 
            font-weight: 700; 
            cursor: pointer;
            font-size: 13px;
            color: var(--intersport-blue);
            outline: none;
        }
        select:focus { border-color: var(--isostar-yellow); }

        #product-nav-header {
            font-size: 12px;
            font-weight: 900;
            color: var(--intersport-blue);
            margin: 10px 0;
            padding-bottom: 8px;
            border-bottom: 3px solid var(--isostar-yellow);
            text-transform: uppercase;
        }

        #scrollable-catalog {
            flex-grow: 1; 
            overflow-y: auto; 
            margin-top: 5px;
            padding-right: 5px;
        }

        .nav-card {
            display: flex; 
            align-items: center; 
            padding: 12px;
            cursor: pointer; 
            border-radius: 10px; 
            transition: var(--transition-smooth);
            margin-bottom: 5px;
            background: #f8fafc;
            border: 1px solid transparent;
        }
        .nav-card:hover { 
            background: #fff; 
            border-color: var(--isostar-yellow);
            transform: translateX(5px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
        }
        .nav-card span { 
            font-size: 12px; 
            font-weight: 700; 
            color: #334155;
            line-height: 1.3;
        }

        /* ========================================================================
           RESPONSIVE UI : PANNEAU DROIT (ANALYSE PRODUIT)
           ======================================================================== */
        #info-panel-right {
            position: absolute; 
            top: 20px; 
            right: -500px; /* Masqu√© par d√©faut */
            width: 380px; 
            background: #fff; 
            padding: 30px;
            border-radius: 20px; 
            border-top: 10px solid var(--intersport-blue);
            box-shadow: -15px 20px 50px rgba(0,0,0,0.2);
            transition: right 0.8s cubic-bezier(0.19, 1, 0.22, 1);
            z-index: 1001;
        }
        #info-panel-right.active { right: 20px; }

        /* Mobile adaptation pour le panneau droit */
        @media (max-width: 768px) {
            #info-panel-right { width: 320px; padding: 20px; }
            #panel-product-title { font-size: 22px !important; }
        }

        @media (max-width: 480px) {
            #info-panel-right {
                width: 90%;
                right: 5% !important;
                left: 5%;
                top: 50px;
                bottom: auto;
            }
        }

        .badge-cat {
            background: var(--intersport-red);
            color: #fff;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 10px;
            font-weight: 900;
            text-transform: uppercase;
            display: inline-block;
            margin-bottom: 12px;
        }

        #panel-product-title { 
            margin: 0 0 10px 0; 
            color: var(--intersport-blue); 
            font-size: 26px; 
            font-weight: 900; 
            line-height: 1.1;
        }

        #panel-product-desc { 
            font-size: 14px; 
            color: #4b5563; 
            line-height: 1.6; 
            margin-bottom: 25px;
        }

        .merch-analysis-box {
            background: #fffbe6; 
            padding: 20px; 
            border-radius: 12px; 
            border-left: 6px solid #fbc02d;
        }

        .merch-header {
            font-size: 11px; 
            color: #92400e; 
            font-weight: 900; 
            margin: 0 0 8px 0; 
            text-transform: uppercase;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        /* --- BOUTONS --- */
        .btn-ui {
            background: var(--isostar-yellow); 
            color: #000; 
            border: none; 
            padding: 16px;
            border-radius: 12px; 
            cursor: pointer; 
            font-weight: 800; 
            width: 100%; 
            margin-top: 25px;
            text-transform: uppercase;
            letter-spacing: 1px;
            font-size: 13px;
            transition: all 0.3s;
            box-shadow: 0 4px 15px rgba(255, 222, 0, 0.3);
        }
        .btn-ui:hover { 
            background: #000; 
            color: #fff;
            transform: translateY(-2px);
        }

        #reset-cam-trigger { 
            background: var(--intersport-blue); 
            color: #fff; 
            display: none; 
        }

        /* Bouton mobile pour ouvrir le menu */
        #mobile-menu-toggle {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            display: none;
            z-index: 2000;
            background: var(--intersport-blue);
            color: white;
            padding: 12px 24px;
            border-radius: 30px;
            font-weight: 900;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }

        @media (max-width: 480px) {
            #mobile-menu-toggle { display: block; }
        }

        /* --- LOADING SCREEN --- */
        #loading-overlay {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: #fff;
            display: flex; justify-content: center; align-items: center;
            z-index: 9999; flex-direction: column;
            transition: opacity 0.8s ease;
        }

        .loader-ring {
            width: 60px; height: 60px;
            border: 6px solid #f3f3f3;
            border-top: 6px solid var(--isostar-yellow);
            border-radius: 50%;
            animation: spin 1s cubic-bezier(0.5, 0, 0.5, 1) infinite;
            margin-bottom: 20px;
        }

        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 10px; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--isostar-yellow); }

    </style>
</head>
<body>

    <div id="loading-overlay">
        <div class="loader-ring"></div>
        <h2 style="color:var(--intersport-blue); text-transform:uppercase; font-size:18px;">Simulation de Merchandising</h2>
        <p style="color:#64748b; font-weight:600; margin-top:5px;">Remplissage massif des √©tag√®res Isostar...</p>
    </div>

    <div id="ui-left">
        <h1 class="brand-title">ISOSTAR 3D</h1>
        <span class="project-tag">Planogramme National v8.0</span>
        
        <label>Configuration du Magasin</label>
        <select id="select-store-size">
            <option value="s1">1. Format Proximit√© (Petit Rack)</option>
            <option value="s2">2. Station-Service (TG Etroite)</option>
            <option value="s3" selected>3. Supermarch√© (1 El√©ment Standard)</option>
            <option value="s4">4. Supermarch√© (2 El√©ments - 2M66)</option>
            <option value="s5">5. Hypermarch√© (3 El√©ments - 4M00)</option>
            <option value="s6">6. Flagship G√©ant (4 El√©ments - 5M33)</option>
        </select>

        <div id="product-nav-header">üì¶ Navigation Produits</div>
        <div id="scrollable-catalog">
            </div>

        <div style="margin-top:15px; font-size:11px; color:#94a3b8; background:#f8fafc; padding:12px; border-radius:10px; line-height:1.4; border: 1px solid #e2e8f0;">
            <b>GUIDE DE NAVIGATION :</b><br>
            ‚Ä¢ Rotation : Clic Gauche<br>
            ‚Ä¢ Translation : Clic Droit<br>
            ‚Ä¢ Zoom : Molette ou Pincer
        </div>
    </div>

    <div id="info-panel-right">
        <div class="badge-cat" id="product-cat-label">Cat√©gorie</div>
        <h2 id="panel-product-title">Nom du Produit</h2>
        <p id="panel-product-desc">Description commerciale du produit Isostar.</p>
        
        <div class="merch-analysis-box">
            <p class="merch-header">üìä Analyse du Merchandiser</p>
            <p id="panel-product-merch" style="margin:0; font-size:13px; font-style:italic; color:#374151; line-height:1.6;"></p>
        </div>
        
        <button id="reset-cam-trigger" class="btn-ui" onclick="handleCameraReset()">üîÑ LIB√âRER LA CAM√âRA (RETOUR)</button>
    </div>

    <button id="mobile-menu-toggle" onclick="toggleMobileMenu()">MENU CATALOGUE</button>

    <script type="importmap">
        {
            "imports": {
                "three": "https://unpkg.com/three@0.162.0/build/three.module.js",
                "three/addons/": "https://unpkg.com/three@0.162.0/examples/jsm/"
            }
        }
    </script>

    <script type="module">
        import * as THREE from 'three';
        import { OrbitControls } from 'three/addons/controls/OrbitControls.js';

        /* ========================================================================
           1. DATA : CATALOGUE OFFICIEL (14 PRODUITS)
           V√âRIFICATION DES TERMES EXACTS 
           V√âRIFICATION DES NOMS DE FICHIERS JPG
           ======================================================================== */
        
        const FULL_CATALOG = [
            { 
                id: 0, img: 'pastille effervecense.jpg', shape: 'cylinder', scale: [0.14, 0.45, 0.14], width: 0.17, facing: 4, 
                name: "Pastilles Effervescentes √âlectrolytes", cat: "HYDRATATION", color: 0xffde00, 
                desc: "Formule isotonique sans calorie. Id√©al pour optimiser l'hydratation lors d'efforts courts ou en compl√©ment d'un apport glucidique s√©par√©.",
                merch: "PLACEMENT HAUT (Yeux). Produit d'impulsion strat√©gique. Sa forte visibilit√© en haut du rayon attire le regard d√®s l'entr√©e en lin√©aire." 
            },
            { 
                id: 1, img: 'gel energy booster.jpg', shape: 'box', scale: [0.22, 0.35, 0.08], width: 0.24, facing: 5, 
                name: "Gel Energy Booster", cat: "√âNERGIE INSTANTAN√âE", color: 0xffffff, 
                desc: "Gel concentr√© coup de fouet enrichi en caf√©ine et vitamines B1, B2, B6 et PP pour les moments les plus intenses de la comp√©tition.",
                merch: "NIVEAU SUP√âRIEUR. Produit technique √† forte valeur ajout√©e. Un facing de 5 unit√©s garantit un bloc visuel coh√©rent et massif." 
            },
            { 
                id: 2, img: 'gel endurance longue distance.jpg', shape: 'box', scale: [0.22, 0.30, 0.05], width: 0.24, facing: 5, 
                name: "Gel Endurance Longue Distance", cat: "ENDURANCE", color: 0xc0c0c0, 
                desc: "Assimilation progressive des glucides pour les efforts de longue dur√©e (> 2 heures). R√©duit la fatigue et maintient la glyc√©mie.",
                merch: "P√îLE PERFORMANCE. Regroup√© avec les boosters pour cr√©er un univers technique. Sa couleur argent√©e tranche avec le jaune classique." 
            },
            { 
                id: 3, img: 'poudre fast idratation.jpg', shape: 'cylinder', scale: [0.25, 0.48, 0.25], width: 0.29, facing: 3, 
                name: "Poudre Fast Hydration", cat: "HYDRATATION PR√âPARATION", color: 0xffde00, 
                desc: "Le format pot incontournable pour pr√©parer ses boissons avant l'effort. Isotonie parfaite pour une absorption rapide de l'eau.",
                merch: "ZONE HAUTE. Format pot iconique d'Isostar. Installe l'identit√© de marque d√®s le premier niveau d'√©tag√®re pour rassurer le client." 
            },
            { 
                id: 4, img: 'poudre hydrate perform.jpg', shape: 'cylinder', scale: [0.25, 0.48, 0.25], width: 0.29, facing: 3, 
                name: "Poudre Hydrate & Perform", cat: "PERFORMANCE √âLITE", color: 0xffde00, 
                desc: "R√©f√©rence historique du sport d'endurance. Utilis√© par les marathoniens et triathl√®tes pour le maintien de l'√©quilibre min√©ral.",
                merch: "C≈íUR DE GAMME. Plac√© strat√©giquement pour stabiliser le regard du client sur la marque. Pilier visuel central du planogramme." 
            },
            { 
                id: 5, img: 'barre endurance max.jpg', shape: 'box', scale: [0.45, 0.15, 0.25], width: 0.47, facing: 3, 
                name: "Barre Endurance Max", cat: "SNACKING SPORTIF", color: 0xffde00, 
                desc: "Barre de c√©r√©ales √©nerg√©tique riche en glucides complexes. Texture fondante et digestion facile pour une √©nergie longue dur√©e.",
                merch: "ZONE DOR√âE (Mains). Produit √† tr√®s forte rotation (20/80). Doit √™tre attrap√© instinctivement sans aucune difficult√© d'acc√®s." 
            },
            { 
                id: 6, img: 'barre energie chocolat.jpg', shape: 'box', scale: [0.45, 0.15, 0.25], width: 0.47, facing: 3, 
                name: "Barre √ânergie Chocolat", cat: "SNACKING PLAISIR", color: 0x3d2315, 
                desc: "Le best-seller absolu. Gourmandise et efficacit√© √©nerg√©tique. Apport glucidique optimal coupl√© au croquant du chocolat au lait.",
                merch: "√âPICENTRE DU RAYON. C'est le produit g√©n√©rateur de trafic. Doit occuper la position la plus centrale et visible du meuble entier." 
            },
            { 
                id: 7, img: 'barre energie fruit rouge.jpg', shape: 'box', scale: [0.45, 0.15, 0.25], width: 0.47, facing: 3, 
                name: "Barre √ânergie Fruits Rouges", cat: "SNACKING FRUIT√â", color: 0xce0f2d, 
                desc: "Alternative fruit√©e riche en vitamines C et E. Parfait pour varier les apports lors des sorties de v√©lo ou de randonn√©e.",
                merch: "OFFRE COMPL√âMENTAIRE. Plac√© √† droite du chocolat (sens de lecture) pour inciter √† l'achat multiple et √† la d√©couverte de saveur." 
            },
            { 
                id: 8, img: 'protein bar caramel.jpg', shape: 'box', scale: [0.35, 0.25, 0.25], width: 0.37, facing: 4, 
                name: "Protein Bar Caramel", cat: "R√âCUP√âRATION MUSCULAIRE", color: 0x00aae4, 
                desc: "Barre post-effort riche en prot√©ines pour favoriser la r√©g√©n√©ration des fibres musculaires apr√®s une s√©ance de musculation ou de cardio.",
                merch: "ZONE DE RUPTURE VISUELLE. Le passage au bleu ciel signale clairement le changement d'usage du produit vers la phase post-effort." 
            },
            { 
                id: 9, img: 'protein barre cruch.jpg', shape: 'box', scale: [0.35, 0.25, 0.25], width: 0.37, facing: 4, 
                name: "Protein Bar Crunch", cat: "R√âCUP√âRATION NUTRITION", color: 0x00aae4, 
                desc: "Le plaisir de la r√©cup√©ration. Texture croustillante unique et apport √©lev√© en prot√©ines pour une reconstruction optimale.",
                merch: "SEGMENT R√âCUP√âRATION. Plac√© en fin de bloc barres. Sert de transition vers les boissons de construction prot√©in√©es situ√©es en bas." 
            },
            { 
                id: 10, img: 'Hydrate perform citron.jpg', shape: 'cylinder', scale: [0.18, 0.65, 0.18], width: 0.21, facing: 6, 
                name: "Hydrate & Perform Citron", cat: "READY-TO-DRINK", color: 0xffde00, 
                desc: "Boisson isotonique pr√™te √† boire 500ml. Bouchon sport ergonomique pour s'hydrater sans s'arr√™ter. Isotonie imm√©diate.",
                merch: "NIVEAU BAS (Genoux). Produit dynamique. Le facing massif de 6 unit√©s cr√©e un impact color√© fort pour attirer les sportifs press√©s." 
            },
            { 
                id: 11, img: 'Hydrate perform orange.jpg', shape: 'cylinder', scale: [0.18, 0.65, 0.18], width: 0.21, facing: 6, 
                name: "Hydrate & Perform Orange", cat: "READY-TO-DRINK", color: 0xffde00, 
                desc: "Version orange de la c√©l√®bre boisson isotonique. Go√ªt frais et apport imm√©diat en min√©raux perdus lors de la transpiration.",
                merch: "ORIENTATION CLIENT. Toutes les √©tiquettes sont pivot√©es √† 180¬∞ pour pr√©senter le logo Isostar face au client d√®s le premier coup d'≈ìil." 
            },
            { 
                id: 12, img: 'recovery drink vanille.jpg', shape: 'box', scale: [0.38, 0.58, 0.18], width: 0.42, facing: 3, 
                name: "Recovery Drink Vanille", cat: "CONSTRUCTION MUSCULAIRE", color: 0x111111, 
                desc: "Boisson de r√©cup√©ration en poudre haute teneur prot√©ique. Aide √† la reconstruction des tissus apr√®s des chocs traumatiques.",
                merch: "NIVEAU SOL (Destination). Produit lourd et technique. Le client cible accepte l'effort de se baisser pour ce format sp√©cifique." 
            },
            { 
                id: 13, img: 'recovery drink chocolat.jpg', shape: 'box', scale: [0.38, 0.58, 0.18], width: 0.42, facing: 3, 
                name: "Recovery Drink Chocolat", cat: "R√âCUP√âRATION PERFORMANCE", color: 0x111111, 
                desc: "Solution de r√©cup√©ration compl√®te post-s√©ance intense. M√©lange optimal de glucides et prot√©ines pour refaire les stocks d'√©nergie.",
                merch: "FONDATION DU LIN√âAIRE. Les gros volumes en partie basse stabilisent visuellement le planogramme et asseoient la puissance de marque." 
            },
        ];

        /* ========================================================================
           2. FORMATS DES MAGASINS : LOGIQUE DE SC√àNE
           ======================================================================== */
        const STORE_MODELS = {
            s1: { width: 3.0, shelves: 4, cam: 8.5 }, 
            s2: { width: 4.5, shelves: 4, cam: 10.5 },
            s3: { width: 6.5, shelves: 5, cam: 13.0 }, // El√©ment Standard 1M33 (Remplissage massif)
            s4: { width: 10.0, shelves: 5, cam: 16.5 },
            s5: { width: 14.5, shelves: 6, cam: 22.0 },
            s6: { width: 20.0, shelves: 6, cam: 30.0 } // Format Flagship G√©ant
        };

        /* ========================================================================
           3. VARIABLES GLOBALES ET INITIALISATION DU MOTEUR
           ======================================================================== */
        let scene, camera, renderer, controls, raycaster, mouse;
        let gondolaGroup, textureLoader;
        let isFocus = false;
        let isResetting = false;
        
        let startCameraPosition = new THREE.Vector3();
        let currentTargetPosition = new THREE.Vector3(0, 1.8, 0);
        let activeZoomCamPos = new THREE.Vector3();
        let activeZoomTarget = new THREE.Vector3();

        function bootstrap() {
            // Cr√©ation de l'environnement 3D
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0xf2f5f8);
            scene.fog = new THREE.Fog(0xf2f5f8, 25, 110);

            camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 0.1, 1000);
            
            renderer = new THREE.WebGLRenderer({ antialias: true, logarithmicDepthBuffer: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.shadowMap.enabled = true;
            renderer.shadowMap.type = THREE.PCFSoftShadowMap;
            renderer.outputColorSpace = THREE.SRGBColorSpace;
            document.body.appendChild(renderer.domElement);

            // √âclairage type "Point de Vente"
            const ambientLight = new THREE.AmbientLight(0xffffff, 0.8);
            scene.add(ambientLight);
            const spotLight = new THREE.DirectionalLight(0xffffff, 1.4);
            spotLight.position.set(15, 30, 20);
            spotLight.castShadow = true;
            spotLight.shadow.mapSize.set(4096, 4096);
            scene.add(spotLight);

            // Sol R√©fl√©chissant (Simulation B√©ton Poli)
            const groundPlate = new THREE.Mesh(
                new THREE.PlaneGeometry(400, 400), 
                new THREE.MeshStandardMaterial({ color: 0xdce2e8, roughness: 0.38, metalness: 0.12 })
            );
            groundPlate.rotation.x = -Math.PI / 2;
            groundPlate.receiveShadow = true;
            scene.add(groundPlate);

            // Contr√¥les de la cam√©ra
            controls = new OrbitControls(camera, renderer.domElement);
            controls.enableDamping = true;
            controls.dampingFactor = 0.065;
            controls.maxPolarAngle = Math.PI / 2 - 0.05;

            gondolaGroup = new THREE.Group();
            scene.add(gondolaGroup);
            
            textureLoader = new THREE.TextureLoader();
            raycaster = new THREE.Raycaster();
            mouse = new THREE.Vector2();

            // √âv√©nements du cycle de vie
            window.addEventListener('resize', handleWindowResize);
            window.addEventListener('mousedown', processInteraction);
            document.getElementById('select-store-size').addEventListener('change', (e) => switchStoreLayout(e.target.value));
            
            // Initialisation de la navigation mobile et desktop
            renderCatalogSidebar();
            
            // Chargement du premier planogramme
            switchStoreLayout('s3');
            
            // Masquage de l'√©cran de chargement
            setTimeout(() => { document.getElementById('loading-overlay').style.opacity = 0; }, 1500);
            setTimeout(() => { document.getElementById('loading-overlay').remove(); }, 2200);

            renderFrame();
        }

        /* ========================================================================
           4. ALGORITHME DE REMPLISSAGE MASSIF "ZERO-VOID"
           ======================================================================== */

        function switchStoreLayout(layoutKey) {
            // Destruction de la structure pr√©c√©dente
            while(gondolaGroup.children.length > 0) gondolaGroup.remove(gondolaGroup.children[0]);
            
            const storeConfig = STORE_MODELS[layoutKey];
            startCameraPosition.set(0, 2.5, storeConfig.cam);
            
            if(!isFocus) {
                camera.position.copy(startCameraPosition);
                controls.target.copy(currentTargetPosition);
            }

            assemblePlanogram(storeConfig);
        }

        function assemblePlanogram(config) {
            const hGap = 0.95;
            const shelfDepth = 0.85;
            const hMax = config.shelves * hGap;
            
            // --- MOBILIER DE PR√âSENTATION ---
            const woodMat = new THREE.MeshStandardMaterial({ color: 0xffffff, roughness: 0.28 });
            const backPanel = new THREE.Mesh(
                new THREE.BoxGeometry(config.width + 0.35, hMax + 0.9, 0.15),
                woodMat
            );
            backPanel.position.set(0, hMax/2 + 0.35, -0.48);
            backPanel.receiveShadow = true;
            gondolaGroup.add(backPanel);

            // Plinthe technique (Bas du meuble)
            const basePlinth = new THREE.Mesh(
                new THREE.BoxGeometry(config.width + 0.35, 0.4, shelfDepth + 0.12),
                new THREE.MeshStandardMaterial({ color: 0x1c1c1c })
            );
            basePlinth.position.set(0, 0.2, 0);
            gondolaGroup.add(basePlinth);

            // Fronton Identitaire (Header Intersport)
            const blueBanner = new THREE.Mesh(
                new THREE.BoxGeometry(config.width, 0.65, 0.28),
                new THREE.MeshStandardMaterial({ color: 0x004179 })
            );
            blueBanner.position.set(0, hMax + 0.85, 0);
            gondolaGroup.add(blueBanner);

            // --- G√âN√âRATION √âTAG√àRES ET REMPLISSAGE INT√âGRAL ---
            for(let i=0; i < config.shelves; i++) {
                const yLevel = 0.5 + (i * hGap);
                
                const shelfBoard = new THREE.Mesh(
                    new THREE.BoxGeometry(config.width, 0.06, shelfDepth),
                    new THREE.MeshStandardMaterial({ color: 0xffffff })
                );
                shelfBoard.position.set(0, yLevel - 0.03, 0);
                shelfBoard.receiveShadow = true; shelfBoard.castShadow = true;
                gondolaGroup.add(shelfBoard);

                // Porte-√©tiquette Rouge (Rail de prix)
                const priceRail = new THREE.Mesh(
                    new THREE.BoxGeometry(config.width, 0.085, 0.02),
                    new THREE.MeshBasicMaterial({ color: 0xce0f2d })
                );
                priceRail.position.set(0, yLevel - 0.045, shelfDepth/2 + 0.015);
                gondolaGroup.add(priceRail);

                // --- ALGORITHME DE REMPLISSAGE MASSIF ---
                // D√©finition des produits autoris√©s pour cet √©tage (Psychologie du client)
                let shelfProducts = [];
                if(i === 0) shelfProducts = [FULL_CATALOG[12], FULL_CATALOG[13], FULL_CATALOG[3], FULL_CATALOG[4]]; // Bas : Lourd/Destination
                else if(i === 1) shelfProducts = [FULL_CATALOG[10], FULL_CATALOG[11]]; // Boissons dynamiques
                else if(i === config.shelves - 1) shelfProducts = [FULL_CATALOG[0], FULL_CATALOG[1], FULL_CATALOG[2]]; // Haut : Impulsion/Technique
                else shelfProducts = [FULL_CATALOG[5], FULL_CATALOG[6], FULL_CATALOG[7], FULL_CATALOG[8], FULL_CATALOG[9]]; // Milieu : Snacking/C≈ìur

                runZeroVoidAlgorithm(config.width, yLevel, shelfProducts);
            }
        }

        function runZeroVoidAlgorithm(linearWidth, yPos, productSelection) {
            let cursorX = -linearWidth / 2 + 0.18; // Offset initial gauche
            let selectionIndex = 0;

            // Boucle infinie de remplissage jusqu'√† saturation de la largeur
            while(cursorX < linearWidth / 2 - 0.28) {
                const activeProd = productSelection[selectionIndex % productSelection.length];
                
                // Pose du bloc de facings complet
                for(let f=0; f < activeProd.facing; f++) {
                    // S√©curit√© de d√©bordement droit
                    if(cursorX + activeProd.width > linearWidth / 2 - 0.12) break;
                    
                    spawnProductInstance(activeProd, cursorX + activeProd.width/2, yPos);
                    cursorX += activeProd.width + 0.006; // √âcart millim√©trique r√©aliste
                }
                
                cursorX += 0.14; // Espace inter-r√©f√©rences strat√©gique
                selectionIndex++;
            }
        }

        function spawnProductInstance(data, x, y) {
            // Chargement de la texture JPG Haute Qualit√©
            const diffuseMap = textureLoader.load(data.img);
            diffuseMap.colorSpace = THREE.SRGBColorSpace;
            diffuseMap.anisotropy = 16; // Nettet√© sous angles rasants
            
            const faceMat = new THREE.MeshStandardMaterial({ map: diffuseMap, roughness: 0.42 });
            const sideMat = new THREE.MeshStandardMaterial({ color: data.color || 0xd1d5db, roughness: 0.58 });

            let finalMesh;
            if(data.shape === 'cylinder') {
                // Cylindres : Bouteilles Citron/Orange et Poudres
                finalMesh = new THREE.Mesh(new THREE.CylinderGeometry(data.scale[0], data.scale[0], data.scale[1], 36), faceMat);
                // --- ROTATION CRITIQUE DESIGN (180¬∞) ---
                finalMesh.rotation.y = Math.PI; 
            } else {
                // Bo√Ætes : Barres, Gels et Recovery
                // Face n¬∞4 = Devant
                finalMesh = new THREE.Mesh(
                    new THREE.BoxGeometry(data.scale[0], data.scale[1], data.scale[2]),
                    [sideMat, sideMat, sideMat, sideMat, faceMat, sideMat]
                );
            }
            
            finalMesh.position.set(x, y + data.scale[1]/2 + 0.02, 0);
            finalMesh.castShadow = true;
            finalMesh.receiveShadow = true;
            finalMesh.userData = data; // Injection des m√©tadonn√©es pour l'UI
            gondolaGroup.add(finalMesh);
        }

        /* ========================================================================
           5. INTERACTIVIT√â ET NAVIGATION
           ======================================================================== */

        function processInteraction(event) {
            if(event.target.closest('#ui-left') || event.target.closest('#info-panel-right')) return;
            
            isResetting = false; // Interruption imm√©diate du retour automatique

            // D√©tection des clics sur mobile et desktop
            const clientX = event.clientX || (event.touches ? event.touches[0].clientX : 0);
            const clientY = event.clientY || (event.touches ? event.touches[0].clientY : 0);

            mouse.x = (clientX / window.innerWidth) * 2 - 1;
            mouse.y = -(clientY / window.innerHeight) * 2 + 1;
            
            raycaster.setFromCamera(mouse, camera);
            const intersectList = raycaster.intersectObjects(gondolaGroup.children, true);
            
            if (intersectList.length > 0) {
                let target = intersectList[0].object;
                while(target.parent && !target.userData.name) target = target.parent;
                if(target.userData.name) zoomToTargetProduct(target);
            }
        }

        function zoomToTargetProduct(obj) {
            isFocus = true;
            isResetting = false;
            
            const metadata = obj.userData;
            document.getElementById('product-cat-label').innerText = metadata.cat;
            document.getElementById('panel-product-title').innerText = metadata.name;
            document.getElementById('panel-product-desc').innerText = metadata.desc;
            document.getElementById('panel-product-merch').innerText = metadata.merch;
            document.getElementById('info-panel-right').classList.add('active');
            document.getElementById('reset-cam-trigger').style.display = 'block';

            // Param√©trage des cibles d'interpolation
            const worldPos = new THREE.Vector3();
            obj.getWorldPosition(worldPos);
            activeZoomTarget.copy(worldPos);
            // Cam√©ra positionn√©e id√©alement devant l'√©tag√®re
            activeZoomCamPos.copy(worldPos).add(new THREE.Vector3(0, 0.22, 1.45)); 
        }

        window.handleCameraReset = () => {
            isFocus = false;
            isResetting = true; // D√©clenche le lerp de retour dans renderFrame()
            document.getElementById('info-panel-right').classList.remove('active');
            document.getElementById('reset-cam-trigger').style.display = 'none';
        };

        function renderCatalogSidebar() {
            const list = document.getElementById('scrollable-catalog');
            FULL_CATALOG.forEach(prod => {
                const card = document.createElement('div');
                card.className = 'nav-card';
                card.innerHTML = `<span>${prod.name}</span>`;
                card.onclick = () => {
                    let mesh = null;
                    gondolaGroup.traverse(m => { if(m.userData.name === prod.name && !mesh) mesh = m; });
                    if(mesh) zoomToTargetProduct(mesh);
                };
                list.appendChild(card);
            });
        }

        window.toggleMobileMenu = () => {
            document.getElementById('ui-left').classList.toggle('mobile-active');
        };

        function handleWindowResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        }

        function renderFrame() {
            requestAnimationFrame(renderFrame);
            
            if(isFocus) {
                // Transition fluide vers l'objet s√©lectionn√©
                camera.position.lerp(activeZoomCamPos, 0.1);
                controls.target.lerp(activeZoomTarget, 0.1);
            } else if(isResetting) {
                // Transition fluide vers le point de base format magasin
                camera.position.lerp(startCameraPosition, 0.1);
                controls.target.lerp(currentTargetPosition, 0.1);
                
                // Fin du for√ßage de cam√©ra d√®s proximit√©
                if(camera.position.distanceTo(startCameraPosition) < 0.15) isResetting = false;
            }
            
            controls.update();
            renderer.render(scene, camera);
        }

        // D√©marrage global de l'application
        bootstrap();
    </script>
</body>
</html>
