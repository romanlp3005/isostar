<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ISOSTAR 3D MASTER - SIMULATEUR MERCHANDISING NATIONAL v9.0</title>
    <style>
        :root {
            --iso-yellow: #ffde00; /* Identit√© Visuelle Isostar */
            --inter-blue: #004179; /* Identit√© Visuelle Intersport */
            --inter-red: #ce0f2d;  /* Identit√© Visuelle Promotionnelle */
            --ui-white: rgba(255, 255, 255, 0.98);
            --ui-dark: #0f172a;
            --radius-xl: 24px;
            --radius-lg: 16px;
            --shadow-pro: 0 25px 60px -15px rgba(0, 0, 0, 0.3);
            --font-main: 'Segoe UI', system-ui, -apple-system, sans-serif;
        }

        /* --- R√âGLAGES STRUCTURELS --- */
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; font-family: var(--font-main); background-color: #000; }
        canvas { display: block; outline: none; }

        /* --- LOADER SYST√àME --- */
        #master-loader { position: fixed; inset: 0; background: #fff; display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 9999; transition: opacity 0.8s ease-out; }
        .loading-bar-container { width: 240px; height: 4px; background: #eee; border-radius: 10px; margin-top: 25px; overflow: hidden; }
        .loading-bar-fill { width: 0%; height: 100%; background: var(--iso-yellow); animation: load-anim 2s forwards cubic-bezier(0.65, 0, 0.35, 1); }
        @keyframes load-anim { to { width: 100%; } }
        @keyframes spin-iso { to { transform: rotate(360deg); } }
        .spinner { width: 50px; height: 50px; border: 4px solid #f3f3f3; border-top: 4px solid var(--iso-yellow); border-radius: 50%; animation: spin-iso 1s infinite linear; }

        /* --- INTERFACE RESPONSIVE GAUCHE (DASHBOARD) --- */
        #ui-left-panel {
            position: absolute; top: 20px; left: 20px; bottom: 20px;
            width: 340px; background: var(--ui-white); border-radius: var(--radius-xl);
            display: flex; flex-direction: column; z-index: 100; box-shadow: var(--shadow-pro);
            border-left: 8px solid var(--iso-yellow); transition: all 0.5s cubic-bezier(0.19, 1, 0.22, 1);
        }

        .ui-header { padding: 30px; border-bottom: 1px solid #f1f5f9; background: linear-gradient(135deg, #fff, #f8fafc); border-radius: var(--radius-xl) var(--radius-xl) 0 0; }
        .ui-title { font-size: 28px; font-weight: 900; text-transform: uppercase; color: #000; margin: 0; letter-spacing: -1px; }
        .ui-version { font-size: 10px; font-weight: 800; color: #94a3b8; text-transform: uppercase; letter-spacing: 3px; display: block; margin-top: 5px; }

        .ui-controls { padding: 25px 30px; }
        .control-label { font-size: 11px; font-weight: 900; color: var(--inter-blue); text-transform: uppercase; margin-bottom: 10px; display: block; }
        
        select {
            width: 100%; padding: 16px; border: 2px solid #e2e8f0; border-radius: var(--radius-lg);
            background: #fff; color: var(--inter-blue); font-weight: 700; cursor: pointer; outline: none;
            transition: all 0.3s; font-size: 14px;
        }
        select:hover { border-color: var(--iso-yellow); box-shadow: 0 5px 15px rgba(0,0,0,0.05); }

        #catalog-scroll-area { flex-grow: 1; overflow-y: auto; padding: 10px 30px 30px 30px; }
        .catalog-header-text { font-size: 13px; font-weight: 900; color: var(--inter-blue); text-transform: uppercase; margin: 15px 0; border-bottom: 3px solid var(--iso-yellow); padding-bottom: 8px; }

        .nav-item {
            display: flex; align-items: center; padding: 14px; margin-bottom: 10px;
            background: #f8fafc; border-radius: var(--radius-lg); cursor: pointer;
            transition: all 0.3s; border: 1px solid transparent;
        }
        .nav-item:hover { transform: scale(1.03) translateX(10px); border-color: var(--iso-yellow); background: #fff; box-shadow: 0 10px 20px rgba(0,0,0,0.05); }
        .nav-item span { font-size: 12px; font-weight: 700; color: #334155; line-height: 1.3; }

        /* --- INTERFACE RESPONSIVE DROITE (MODALE FOCUS) --- */
        #ui-product-modal {
            position: absolute; top: 20px; right: 20px; bottom: 20px;
            width: 420px; background: #fff; border-radius: var(--radius-xl);
            display: flex; flex-direction: column; z-index: 110; box-shadow: var(--shadow-pro);
            border-top: 12px solid var(--inter-blue); transform: translateX(calc(100% + 50px));
            transition: transform 0.7s cubic-bezier(0.19, 1, 0.22, 1);
        }
        #ui-product-modal.active { transform: translateX(0); }

        .modal-content { padding: 40px; overflow-y: auto; flex-grow: 1; }
        .pill-cat { background: var(--inter-red); color: #fff; padding: 6px 16px; border-radius: 50px; font-size: 11px; font-weight: 900; display: inline-block; margin-bottom: 20px; text-transform: uppercase; }
        .prod-name { font-size: 32px; font-weight: 900; color: var(--inter-blue); line-height: 1; margin: 0 0 20px 0; letter-spacing: -1px; }
        .prod-description { color: #64748b; font-size: 15px; line-height: 1.7; margin-bottom: 35px; }

        .merch-theory-card { 
            background: #fffbe6; padding: 25px; border-radius: var(--radius-lg); 
            border-left: 8px solid #fbc02d; position: relative; overflow: hidden;
        }
        .merch-theory-card::before { content: 'STRATEGY'; position: absolute; top: -10px; right: -10px; font-size: 40px; font-weight: 900; color: rgba(251, 192, 45, 0.08); }

        /* --- BOUTON DE SORTIE / RESET --- */
        .btn-system {
            background: var(--iso-yellow); border: none; padding: 20px; border-radius: var(--radius-lg);
            width: 100%; font-weight: 900; text-transform: uppercase; cursor: pointer; transition: 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            box-shadow: 0 8px 25px rgba(255, 222, 0, 0.4); font-size: 14px; letter-spacing: 1px;
        }
        .btn-system:hover { background: #000; color: #fff; transform: translateY(-5px); box-shadow: 0 15px 35px rgba(0,0,0,0.3); }
        #btn-camera-free { background: var(--inter-blue); color: #fff; display: none; margin-top: 25px; box-shadow: 0 8px 25px rgba(0, 65, 121, 0.3); }

        /* --- ADAPTATION MOBILE TOTALE --- */
        @media (max-width: 1100px) {
            #ui-left-panel { width: 300px; left: 10px; top: 10px; bottom: 10px; }
            #ui-product-modal { width: 360px; right: 10px; }
        }

        @media (max-width: 850px) {
            #ui-left-panel { width: calc(100% - 20px); height: auto; bottom: auto; max-height: 40%; }
            #ui-product-modal { width: calc(100% - 20px); left: 10px; right: 10px; top: auto; height: 65%; transform: translateY(115%); }
            #ui-product-modal.active { transform: translateY(0); }
            #catalog-scroll-area { display: none; } /* On cache la liste sur petit mobile pour la visibilit√© */
            .ui-header { padding: 15px 25px; }
            .ui-controls { padding: 15px 25px; }
        }

        /* --- NAVIGATION TIPS --- */
        .nav-tips { position: absolute; bottom: 30px; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.6); padding: 10px 25px; border-radius: 50px; color: #fff; font-size: 11px; z-index: 50; backdrop-filter: blur(10px); pointer-events: none; border: 1px solid rgba(255,255,255,0.2); }
    </style>
</head>
<body>

    <div id="master-loader">
        <div class="spinner"></div>
        <h2 style="color:var(--inter-blue); margin:20px 0 5px 0; font-weight:900;">ISOSTAR MERCHANDISING</h2>
        <p style="color:#64748b; font-weight:600; font-size:14px;">G√©n√©ration du planogramme 3D sans vide...</p>
        <div class="loading-bar-container"><div class="loading-bar-fill"></div></div>
    </div>

    <div id="viewport-3d"></div>

    <nav id="ui-left-panel">
        <div class="ui-header">
            <h1 class="ui-title">ISOSTAR 3D</h1>
            <span class="ui-version">Planogramme National v9.0</span>
        </div>

        <div class="ui-controls">
            <label>Format du Point de Vente</label>
            <select id="select-store-type">
                <option value="s1">1. Proximit√© (Petit Rack 2M)</option>
                <option value="s2">2. Station-Service (TG 3.5M)</option>
                <option value="s3" selected>3. Supermarch√© (Standard 6M)</option>
                <option value="s4">4. Supermarch√© Large (10M)</option>
                <option value="s5">5. Hypermarch√© (G√©ant 15M)</option>
                <option value="s6">6. Flagship / Showroom (22M)</option>
            </select>
        </div>

        <div id="catalog-scroll-area">
            <div class="catalog-header-text">üì¶ Catalogue Officiel (14)</div>
            <div id="nav-list-injection"></div>
        </div>

        <div style="padding: 20px 30px; background: #f1f5f9; border-radius: 0 0 var(--radius-xl) var(--radius-xl); text-align: center;">
            <p style="font-size: 10px; color: #64748b; margin: 0; font-weight: 700; text-transform: uppercase;">Algorithme Looping "Zero-Void" Activ√©</p>
        </div>
    </nav>

    <aside id="ui-product-modal">
        <div class="modal-content">
            <div class="pill-cat" id="display-cat">Cat√©gorie</div>
            <h2 class="prod-name" id="display-name">Produit Isostar</h2>
            <p class="prod-description" id="display-desc">D√©tails techniques du produit.</p>
            
            <div class="merch-theory-card">
                <div style="font-size:12px; font-weight:900; color:#d4a017; margin-bottom:12px; text-transform:uppercase; display:flex; align-items:center; gap:8px;">
                    <span style="font-size:18px;">üéØ</span> Justification Merchandising
                </div>
                <div id="display-merch" style="font-size:14px; font-style:italic; color:#475569; line-height:1.6;">Analyse du placement strat√©gique.</div>
            </div>

            <button id="btn-camera-free" class="btn-system" onclick="handleCameraRelease()">üîì LIB√âRER LA CAM√âRA (RETOUR)</button>
        </div>
    </aside>

    <div class="nav-tips">üñ±Ô∏è Rotation (Clic G) | ‚ÜïÔ∏è Zoom (Molette) | ‚ÜîÔ∏è D√©placement (Clic D)</div>

    <script type="importmap">
        {
            "imports": {
                "three": "https://unpkg.com/three@0.162.0/build/three.module.js",
                "three/addons/": "https://unpkg.com/three@0.162.0/examples/jsm/"
            }
        }
    </script>

    <script type="module">
        import * as THREE from 'three';
        import { OrbitControls } from 'three/addons/controls/OrbitControls.js';

        /* =======================================================================
           1. CORE DATA : CATALOGUE OFFICIEL (14 TERMES EXACTS)
           V√âRIFICATION DES FICHIERS JPG
           =======================================================================
        */
        const ISOSTAR_MASTER_DATA = [
            { 
                id: 0, img: 'pastille effervecense.jpg', shape: 'cylinder', scale: [0.14, 0.45, 0.14], width: 0.18, facing: 4, 
                name: "Pastilles Effervescentes √âlectrolytes", cat: "HYDRATATION", color: 0xffde00, 
                desc: "Pastilles riches en Sodium, Magn√©sium et Potassium pour une hydratation cibl√©e sans apport calorique √©lev√©. Format tube pratique pour le transport.",
                merch: "HAUT DE RAYON (Niveau des yeux). Produit d'impulsion strat√©gique. Sa forte visibilit√© en √©tag√®re haute g√©n√®re des ventes compl√©mentaires lors de l'achat d'une boisson." 
            },
            { 
                id: 1, img: 'gel energy booster.jpg', shape: 'box', scale: [0.22, 0.35, 0.08], width: 0.25, facing: 5, 
                name: "Gel Energy Booster", cat: "√âNERGIE INSTANTAN√âE", color: 0xffffff, 
                desc: "Gel concentr√© apportant un coup de fouet imm√©diat gr√¢ce √† sa teneur en glucides et vitamines B1. Indispensable pour les fins de parcours difficiles.",
                merch: "ZONE SUP√âRIEURE. Produit technique √† haute valeur faciale. Le regroupement en bloc massif rassure le consommateur sur l'expertise de la marque." 
            },
            { 
                id: 2, img: 'gel endurance longue distance.jpg', shape: 'box', scale: [0.22, 0.30, 0.05], width: 0.25, facing: 5, 
                name: "Gel Endurance Longue Distance", cat: "ENDURANCE", color: 0xc0c0c0, 
                desc: "Formule sp√©cifiquement √©tudi√©e pour les efforts sup√©rieurs √† 2 heures. Diffusion progressive de l'√©nergie pour √©viter les pics glyc√©miques.",
                merch: "SEGMENTATION TECHNIQUE. Plac√© √† la suite des gels boosters pour guider le consommateur expert vers une solution adapt√©e √† sa pratique (Marathon, Trail)." 
            },
            { 
                id: 3, img: 'poudre fast idratation.jpg', shape: 'cylinder', scale: [0.25, 0.48, 0.25], width: 0.32, facing: 3, 
                name: "Poudre Fast Hydration", cat: "HYDRATATION", color: 0xffde00, 
                desc: "Pr√©paration pour boisson isotonique en format pot √©conomique. Permet de pr√©parer jusqu'√† 10 litres de boisson de l'effort.",
                merch: "NIVEAU SUP√âRIEUR. Le format pot potelant asseoit l'identit√© de marque Isostar sur le lin√©aire haut. Sert d'ancrage visuel majeur." 
            },
            { 
                id: 4, img: 'poudre hydrate perform.jpg', shape: 'cylinder', scale: [0.25, 0.48, 0.25], width: 0.32, facing: 3, 
                name: "Poudre Hydrate & Perform", cat: "PERFORMANCE", color: 0xffde00, 
                desc: "La r√©f√©rence historique Isostar pour tous les sportifs. √âlectrolytes et glucides combin√©s pour une performance durable.",
                merch: "PILIER DE GAMME. Plac√© au centre de la zone sup√©rieure pour stabiliser le flux visuel du client et ancrer le 'jaune Isostar' dans l'esprit du shopper." 
            },
            { 
                id: 5, img: 'barre endurance max.jpg', shape: 'box', scale: [0.45, 0.15, 0.25], width: 0.48, facing: 3, 
                name: "Barre Endurance Max", cat: "SNACKING SPORTIF", color: 0xffde00, 
                desc: "Barre de c√©r√©ales √©nerg√©tique riche en glucides complexes et vitamines. Texture fondante et gourmande pour un plaisir soutenu.",
                merch: "ZONE DOR√âE (Niveau des mains). Produit coeur de march√© (loi des 20/80). Sa position centrale facilite la saisie imm√©diate par le client." 
            },
            { 
                id: 6, img: 'barre energie chocolat.jpg', shape: 'box', scale: [0.45, 0.15, 0.25], width: 0.48, facing: 3, 
                name: "Barre √ânergie Chocolat", cat: "SNACKING SPORTIF", color: 0x3d2315, 
                desc: "Le best-seller mondial. Apport glucidique optimal coupl√© au plaisir du chocolat croquant pour maintenir le moral pendant l'effort.",
                merch: "√âPICENTRE DU RAYON. C'est le produit g√©n√©rateur de trafic. Doit occuper le centre visuel du meuble pour attirer le client d√®s son entr√©e dans l'all√©e." 
            },
            { 
                id: 7, img: 'barre energie fruit rouge.jpg', shape: 'box', scale: [0.45, 0.15, 0.25], width: 0.48, facing: 3, 
                name: "Barre √ânergie Fruits Rouges", cat: "SNACKING SPORTIF", color: 0xce0f2d, 
                desc: "Alternative fruit√©e riche en antioxydants et vitamines. Parfait pour √©viter la saturation du go√ªt chocolat sur les efforts longs.",
                merch: "EXTENSION DE GAMME. Plac√© √† droite du chocolat (sens de lecture) pour inciter √† l'achat multiple de saveurs diff√©rentes." 
            },
            { 
                id: 8, img: 'protein bar caramel.jpg', shape: 'box', scale: [0.35, 0.25, 0.25], width: 0.38, facing: 4, 
                name: "Protein Bar Caramel", cat: "R√âCUP√âRATION", color: 0x00aae4, 
                desc: "Barre post-effort riche en prot√©ines pour favoriser la r√©g√©n√©ration des tissus musculaires apr√®s une s√©ance intensive.",
                merch: "ZONE DE RUPTURE. Le passage au code couleur bleu ciel signale clairement le changement d'usage du produit (√ânergie vers R√©cup√©ration)." 
            },
            { 
                id: 9, img: 'protein barre cruch.jpg', shape: 'box', scale: [0.35, 0.25, 0.25], width: 0.38, facing: 4, 
                name: "Protein Bar Crunch", cat: "R√âCUP√âRATION", color: 0x00aae4, 
                desc: "Barre haute teneur en prot√©ines avec une texture croustillante unique. Un plaisir nutritionnel pour r√©compenser l'effort.",
                merch: "SEGMENTATION R√âCUP√âRATION. Plac√© en fin de bloc barres avant de descendre vers les boissons de construction musculaire." 
            },
            { 
                id: 10, img: 'Hydrate perform citron.jpg', shape: 'cylinder', scale: [0.18, 0.65, 0.18], width: 0.22, facing: 6, 
                name: "Hydrate & Perform Citron", cat: "READY-TO-DRINK", color: 0xffde00, 
                desc: "Boisson isotonique pr√™te √† boire 500ml. Format dynamique avec bouchon sport ergonomique pour s'hydrater sans s'arr√™ter.",
                merch: "NIVEAU BAS (Mains/Genoux). Produit dynamique pour sportifs press√©s. Plac√© en bloc massif pour cr√©er un 'mur' de fra√Æcheur attirant." 
            },
            { 
                id: 11, img: 'Hydrate perform orange.jpg', shape: 'cylinder', scale: [0.18, 0.65, 0.18], width: 0.22, facing: 6, 
                name: "Hydrate & Perform Orange", cat: "READY-TO-DRINK", color: 0xffde00, 
                desc: "La version orange du c√©l√®bre Ready-To-Drink Isostar. Isotonie parfaite pour une absorption gastrique rapide et efficace.",
                merch: "ORIENTATION CLIENT. Toutes les bouteilles sont pivot√©es √† 180¬∞ pour pr√©senter le logo face au client d√®s le d√©but de l'all√©e." 
            },
            { 
                id: 12, img: 'recovery drink vanille.jpg', shape: 'box', scale: [0.38, 0.58, 0.18], width: 0.42, facing: 3, 
                name: "Recovery Drink Vanille", cat: "CONSTRUCTION MUSCULAIRE", color: 0x111111, 
                desc: "Boisson de r√©cup√©ration en poudre riche en prot√©ines. Aide √† r√©duire la fatigue et r√©pare les fibres apr√®s des chocs traumatiques.",
                merch: "NIVEAU SOL (Destination). Produit lourd et technique. Le client cible (expert) accepte de se baisser pour ce format sp√©cifique." 
            },
            { 
                id: 13, img: 'recovery drink chocolat.jpg', shape: 'box', scale: [0.38, 0.58, 0.18], width: 0.42, facing: 3, 
                name: "Recovery Drink Chocolat", cat: "R√âCUP√âRATION GLOBALE", color: 0x111111, 
                desc: "La solution ultime apr√®s la s√©ance. M√©lange optimal de glucides et prot√©ines pour une recharge glycog√©nique et musculaire.",
                merch: "FONDATION DU RAYON. Les gros volumes en bas stabilisent la structure visuelle et la balance du meuble Intersport." 
            },
        ];

        /* =======================================================================
           2. WORLD CONFIGURATION : FORMATS MAGASINS
           =======================================================================
        */
        const STORE_FORMATS = {
            s1: { width: 3.2, shelves: 4, cam: 9, label: "Proximit√©" }, 
            s2: { width: 4.8, shelves: 4, cam: 11, label: "Station-Service" },
            s3: { width: 7.2, shelves: 5, cam: 15, label: "Supermarch√© Urbain" }, // Standard
            s4: { width: 10.5, shelves: 5, cam: 19, label: "Super Standard" },
            s5: { width: 16.0, shelves: 6, cam: 25, label: "Hypermarch√©" },
            s6: { width: 24.0, shelves: 6, cam: 35, label: "Flagship G√©ant" }
        };

        /* =======================================================================
           3. ENGINE VARIABLES & SCENE SETUP
           =======================================================================
        */
        let scene, camera, renderer, controls, raycaster, mouse;
        let gondolaGroup, textureLoader;
        let isFocusActive = false;
        let isResettingCamera = false;
        
        // Positions cibles pour les transitions de cam√©ra
        let homeCamPosition = new THREE.Vector3();
        let homeTargetPosition = new THREE.Vector3(0, 2, 0);
        let targetCamPos = new THREE.Vector3();
        let targetLookAt = new THREE.Vector3();

        function initPlanogramApp() {
            // Cr√©ation de la sc√®ne
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0xf2f5f8);
            scene.fog = new THREE.Fog(0xf2f5f8, 20, 150);

            camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 0.1, 2000);
            
            renderer = new THREE.WebGLRenderer({ antialias: true, logarithmicDepthBuffer: true, powerPreference: "high-performance" });
            renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.shadowMap.enabled = true;
            renderer.shadowMap.type = THREE.PCFSoftShadowMap;
            renderer.outputColorSpace = THREE.SRGBColorSpace;
            document.getElementById('viewport-3d').appendChild(renderer.domElement);

            // √âclairage type "Grande Surface"
            const ambientLight = new THREE.AmbientLight(0xffffff, 0.9);
            scene.add(ambientLight);
            
            const sunlight = new THREE.DirectionalLight(0xffffff, 1.4);
            sunlight.position.set(15, 30, 20);
            sunlight.castShadow = true;
            sunlight.shadow.mapSize.set(4096, 4096);
            sunlight.shadow.camera.left = -50; sunlight.shadow.camera.right = 50;
            sunlight.shadow.camera.top = 50; sunlight.shadow.camera.bottom = -50;
            scene.add(sunlight);

            // Sol de Magasin
            const groundPlate = new THREE.Mesh(
                new THREE.PlaneGeometry(500, 500), 
                new THREE.MeshStandardMaterial({ color: 0xdce2e8, roughness: 0.35, metalness: 0.15 })
            );
            groundPlate.rotation.x = -Math.PI / 2;
            groundPlate.receiveShadow = true;
            scene.add(groundPlate);

            // Syst√®me de Contr√¥les Orbitaux
            controls = new OrbitControls(camera, renderer.domElement);
            controls.enableDamping = true;
            controls.dampingFactor = 0.06;
            controls.maxPolarAngle = Math.PI / 2 - 0.05;
            controls.screenSpacePanning = true;

            gondolaGroup = new THREE.Group();
            scene.add(gondolaGroup);
            
            textureLoader = new THREE.TextureLoader();
            raycaster = new THREE.Raycaster();
            mouse = new THREE.Vector2();

            // √âcouteurs d'√©v√©nements
            window.addEventListener('resize', handleResponsiveUI);
            window.addEventListener('mousedown', onWorldInteraction);
            document.getElementById('select-store-type').addEventListener('change', (e) => executeStoreRebuild(e.target.value));
            
            // Initialisation des menus
            injectCatalogItems();
            
            // Construction initiale
            executeStoreRebuild('s3');
            
            // Sortie du Loader
            setTimeout(() => { 
                document.getElementById('master-loader').style.opacity = 0;
                setTimeout(() => document.getElementById('master-loader').remove(), 1000);
            }, 1800);

            runMainLoop();
        }

        /* =======================================================================
           4. "ZERO-VOID" ALGORITHM : REMPLISSAGE INT√âGRAL
           =======================================================================
        */
        function executeStoreRebuild(formatKey) {
            // Nettoyage de la sc√®ne
            while(gondolaGroup.children.length > 0) gondolaGroup.remove(gondolaGroup.children[0]);
            
            const storeConfig = STORE_FORMATS[formatKey];
            homeCamPosition.set(0, 3, storeConfig.cam);
            
            // Si l'utilisateur n'est pas en train d'analyser un produit, on place la cam√©ra au point HOME
            if(!isFocusActive) {
                camera.position.copy(homeCamPosition);
                controls.target.copy(homeTargetPosition);
            }

            deployFurniture(storeConfig);
        }

        function deployFurniture(cfg) {
            const shelfStep = 0.95;
            const depth = 0.85;
            const totalHeight = cfg.shelves * shelfStep;
            
            // -- FOND DU MEUBLE --
            const backPanel = new THREE.Mesh(
                new THREE.BoxGeometry(cfg.width + 0.4, totalHeight + 1.2, 0.15),
                new THREE.MeshStandardMaterial({ color: 0xffffff, roughness: 0.25 })
            );
            backPanel.position.set(0, totalHeight/2 + 0.4, -0.48);
            backPanel.receiveShadow = true;
            gondolaGroup.add(backPanel);

            // -- PLINTHE BASSE --
            const kickboard = new THREE.Mesh(
                new THREE.BoxGeometry(cfg.width + 0.4, 0.45, depth + 0.1),
                new THREE.MeshStandardMaterial({ color: 0x1a1a1a })
            );
            kickboard.position.set(0, 0.22, 0);
            gondolaGroup.add(kickboard);

            // -- FRONTON BLEU INTERSPORT --
            const banner = new THREE.Mesh(
                new THREE.BoxGeometry(cfg.width, 0.75, 0.25),
                new THREE.MeshStandardMaterial({ color: 0x004179 })
            );
            banner.position.set(0, totalHeight + 0.9, 0);
            gondolaGroup.add(banner);

            // -- R√âP√âTITION DES √âTAG√àRES ET REMPLISSAGE SANS VIDE --
            for(let i=0; i < cfg.shelves; i++) {
                const yPos = 0.6 + (i * shelfStep);
                
                // Tablette en acier laqu√© blanc
                const shelfMat = new THREE.MeshStandardMaterial({ color: 0xffffff });
                const shelfMesh = new THREE.Mesh(
                    new THREE.BoxGeometry(cfg.width, 0.07, depth),
                    shelfMat
                );
                shelfMesh.position.set(0, yPos - 0.035, 0);
                shelfMesh.receiveShadow = true; shelfMesh.castShadow = true;
                gondolaGroup.add(shelfMesh);

                // Porte-Prix Rouge
                const rail = new THREE.Mesh(
                    new THREE.BoxGeometry(cfg.width, 0.08, 0.02),
                    new THREE.MeshBasicMaterial({ color: 0xce0f2d })
                );
                rail.position.set(0, yPos - 0.045, depth/2 + 0.01);
                gondolaGroup.add(rail);

                // CONTENU STRAT√âGIQUE (Remplissage massif par niveau)
                let rowProds = [];
                if(i === 0) rowProds = [ISOSTAR_MASTER_DATA[12], ISOSTAR_MASTER_DATA[13], ISOSTAR_MASTER_DATA[3], ISOSTAR_MASTER_DATA[4]];
                else if(i === 1) rowProds = [ISOSTAR_MASTER_DATA[10], ISOSTAR_MASTER_DATA[11]];
                else if(i === cfg.shelves - 1) rowProds = [ISOSTAR_MASTER_DATA[0], ISOSTAR_MASTER_DATA[1], ISOSTAR_MASTER_DATA[2]];
                else rowProds = [ISOSTAR_MASTER_DATA[5], ISOSTAR_MASTER_DATA[6], ISOSTAR_MASTER_DATA[7], ISOSTAR_MASTER_DATA[8], ISOSTAR_MASTER_DATA[9]];

                performMassFilling(cfg.width, yPos, rowProds);
            }
        }

        function performMassFilling(maxWidth, y, set) {
            let cursorX = -maxWidth / 2 + 0.15; // Marge gauche de d√©part
            let idx = 0;

            // Boucle de remplissage infinie jusqu'au bord droit du meuble
            while(cursorX < maxWidth / 2 - 0.25) {
                const targetData = set[idx % set.length];
                
                // On installe le bloc complet de facings d√©fini dans la base
                for(let f=0; f < targetData.facing; f++) {
                    // S√©curit√© de collision bord droit
                    if(cursorX + targetData.width > maxWidth / 2 - 0.1) break;
                    
                    placeProduct3D(targetData, cursorX + targetData.width/2, y);
                    cursorX += targetData.width + 0.005; // Gap r√©aliste entre bo√Ætes
                }
                
                cursorX += 0.18; // Espace entre deux r√©f√©rences diff√©rentes (marques/segments)
                idx++;
            }
        }

        function placeProduct3D(data, x, y) {
            // Texture haute r√©solution avec filtrage anisotrope
            const texture = textureLoader.load(data.img);
            texture.colorSpace = THREE.SRGBColorSpace;
            texture.anisotropy = 16; 
            
            const matF = new THREE.MeshStandardMaterial({ map: texture, roughness: 0.4 });
            const matS = new THREE.MeshStandardMaterial({ color: data.color || 0xdddddd, roughness: 0.6 });

            let mesh;
            if(data.shape === 'cylinder') {
                // Mod√©lisation cylindrique (Bouteilles / Tubes / Poudres)
                mesh = new THREE.Mesh(new THREE.CylinderGeometry(data.scale[0], data.scale[0], data.scale[1], 48), matF);
                // --- CORRECTION ORIENTATION LOGO CLIENT (180¬∞) ---
                mesh.rotation.y = Math.PI; 
            } else {
                // Mod√©lisation bo√Æte (Barres / Gels / R√©cup√©ration)
                // Mapping : 4 = Frontale
                mesh = new THREE.Mesh(
                    new THREE.BoxGeometry(data.scale[0], data.scale[1], data.scale[2]),
                    [matS, matS, matS, matS, matF, matS]
                );
            }
            
            mesh.position.set(x, y + data.scale[1]/2 + 0.02, 0);
            mesh.castShadow = true;
            mesh.receiveShadow = true;
            mesh.userData = data; // Injection des m√©tadonn√©es
            gondolaGroup.add(mesh);
        }

        /* =======================================================================
           5. INTERACTION & CAMERA RESET SYSTEM
           =======================================================================
        */
        function onWorldInteraction(e) {
            if(e.target.closest('#ui-left-panel') || e.target.closest('#ui-product-modal')) return;
            
            isResettingCamera = false; // D√©sactivation imm√©diate de l'auto-home si mouvement manuel

            mouse.x = (e.clientX / window.innerWidth) * 2 - 1;
            mouse.y = -(e.clientY / window.innerHeight) * 2 + 1;
            
            raycaster.setFromCamera(mouse, camera);
            const intersections = raycaster.intersectObjects(gondolaGroup.children, true);
            
            if (intersections.length > 0) {
                let hit = intersections[0].object;
                while(hit.parent && !hit.userData.name) hit = hit.parent;
                if(hit.userData.name) launchProductFocus(hit);
            }
        }

        function launchProductFocus(obj) {
            isFocusActive = true;
            isResettingCamera = false;
            
            const meta = obj.userData;
            document.getElementById('display-cat').innerText = meta.cat;
            document.getElementById('display-name').innerText = meta.name;
            document.getElementById('display-desc').innerText = meta.desc;
            document.getElementById('display-merch').innerText = meta.merch;
            document.getElementById('ui-product-modal').classList.add('active');
            document.getElementById('btn-camera-free').style.display = 'block';

            // Param√®tres de trajectoire Camera Lerp
            const worldPos = new THREE.Vector3();
            obj.getWorldPosition(worldPos);
            targetLookAt.copy(worldPos);
            // On se place √† 1.5m devant le produit
            targetCamPos.copy(worldPos).add(new THREE.Vector3(0, 0.2, 1.5)); 
        }

        window.handleCameraRelease = () => {
            isFocusActive = false;
            isResettingCamera = true; // D√©clenche l'animation de retour vers le point HOME
            document.getElementById('ui-product-modal').classList.remove('active');
            document.getElementById('btn-camera-free').style.display = 'none';
        };

        function injectCatalogItems() {
            const container = document.getElementById('nav-list-injection');
            ISOSTAR_MASTER_DATA.forEach(p => {
                const item = document.createElement('div');
                item.className = 'nav-item';
                item.innerHTML = `<span>${p.name}</span>`;
                item.onclick = () => {
                    let target = null;
                    gondolaGroup.traverse(m => { if(m.userData.name === p.name && !target) target = m; });
                    if(target) launchProductFocus(target);
                };
                container.appendChild(item);
            });
        }

        function handleResponsiveUI() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        }

        function runMainLoop() {
            requestAnimationFrame(runMainLoop);
            
            if(isFocusActive) {
                // Interpolation vers le produit s√©lectionn√©
                camera.position.lerp(targetCamPos, 0.12);
                controls.target.lerp(targetLookAt, 0.12);
            } else if(isResettingCamera) {
                // Animation fluide de retour vers le point de d√©part du magasin
                camera.position.lerp(homeCamPosition, 0.1);
                controls.target.lerp(homeTargetPosition, 0.1);
                
                // Fin de l'animation si on est assez proche
                if(camera.position.distanceTo(homeCamPosition) < 0.1) isResettingCamera = false;
            }
            
            controls.update();
            renderer.render(scene, camera);
        }

        // D√âMARRAGE GLOBAL
        initPlanogramApp();
    </script>
</body>
</html>
